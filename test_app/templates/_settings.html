
<div id="ui-settings" data-mode="{{ settings_mode or (settings_schema.mode if settings_schema and settings_schema.mode else 'immediate') }}">
  {% set schema = (settings_schema or ui_settings_schema) or {} %}
  {% set fields = schema.fields if schema and schema.fields else [] %}
  {% set status_id = schema.status_id if schema and schema.status_id else 'ui-settings-status' %}
  <div id="{{ status_id }}" class="ui-settings-status" style="margin:8px 0;color:#555"></div>
  <div class="ui-settings-body">
    {% for f in fields %}
      <div class="ui-field" data-field="{{ f.id }}" data-save-path="{{ f.save_path or schema.save_path or '' }}" data-save-method="{{ f.save_method or schema.save_method or 'POST' }}" data-group="{{ f.group or '' }}">
        {% if f.type == 'select' %}
          <label>{{ f.label }}
            <select id="ui-f-{{ f.id }}">
              {% for opt in f.options or [] %}
                <option value="{{ opt.value }}" {% if opt.value == f.value %}selected{% endif %}>{{ opt.label or opt.value }}</option>
              {% endfor %}
            </select>
          </label>
        {% elif f.type == 'checkbox' %}
          <label><input type="checkbox" id="ui-f-{{ f.id }}" {% if f.value %}checked{% endif %}/> {{ f.label }}</label>
        {% else %}
          <label>{{ f.label }} <input type="text" id="ui-f-{{ f.id }}" value="{{ f.value or '' }}"/></label>
        {% endif %}
      </div>
    {% endfor %}
  </div>
  {% if (settings_mode or (schema.mode if schema and schema.mode else None)) == 'manual' %}
    <div style="margin-top:10px"><button id="ui-settings-save">Save</button></div>
  {% endif %}
</div>
<script>
(function(){
  try{
    const root=document.getElementById('ui-settings'); if(!root) return;
    const mode=root.dataset.mode||'immediate';
    const status=document.getElementById('{{ status_id }}');
    function setStatus(ok,msg){ if(status){ status.textContent=msg||(ok?'Saved':'Error'); status.style.color=ok?'#055':'#700'; status.style.background=ok?'#e6ffed':'#ffeaea'; status.style.border='1px solid '+(ok?'#b7f5c7':'#ffb3b3'); status.style.padding='6px 8px'; status.style.borderRadius='4px'; }
      try{ window.dispatchEvent(new CustomEvent('ui-settings-status',{detail:{ok:!!ok,message:msg||''}})); }catch(e){}
    }
    function collect(onlyId){ const data={}; const grouped={}; const fields=root.querySelectorAll('.ui-field'); fields.forEach(function(w){ const id=w.getAttribute('data-field'); if(!id|| (onlyId && onlyId!==id)) return; const group=(w.getAttribute('data-group')||'').trim(); const input=w.querySelector('select, input[type=text], input[type=checkbox]'); if(!input) return; let val; if(input.tagName==='SELECT') val=input.value; else if(input.type==='checkbox') val=input.checked; else val=input.value; if(group){ grouped[group]=grouped[group]||{}; grouped[group][id]=val; } else { data[id]=val; } }); for(const k in grouped){ data[k]=grouped[k]; } return data; }
    async function saveOne(id){ const el=root.querySelector('.ui-field[data-field="'+id+'"]'); if(!el) return; const path=el.getAttribute('data-save-path')||'{{ schema.save_path or '' }}'; const method=el.getAttribute('data-save-method')||'{{ schema.save_method or 'POST' }}'; if(!path){ setStatus(false,'No save_path configured'); return; } const payload=collect(id); try{ const res=await fetch(path,{method:method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)}); const ok=res.ok; let msg= ok?'Saved':'Save failed'; try{ const t=await res.text(); const j=JSON.parse(t); msg=j.detail||(ok?'Saved':'Error'); }catch{} setStatus(ok,msg);}catch(e){ setStatus(false,'Network error'); } }
    function bind(){ const fields=root.querySelectorAll('.ui-field'); fields.forEach(function(w){ const id=w.getAttribute('data-field'); const input=w.querySelector('select, input[type=text], input[type=checkbox]'); if(!input||!id) return; if(mode==='immediate'){ input.addEventListener('change', function(){ saveOne(id); }); } }); const btn=document.getElementById('ui-settings-save'); if(btn){ btn.addEventListener('click', async function(){ const path='{{ schema.save_path or '' }}'; const method='{{ schema.save_method or 'POST' }}'; if(!path){ setStatus(false,'No save_path configured'); return; } const payload=collect(null); try{ const res=await fetch(path,{method:method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)}); const ok=res.ok; let msg= ok?'Saved':'Save failed'; try{ const t=await res.text(); const j=JSON.parse(t); msg=j.detail||(ok?'Saved':'Error'); }catch{} setStatus(ok,msg);}catch(e){ setStatus(false,'Network error'); } }); } }
    bind();
  }catch(e){}
})();
</script>
            