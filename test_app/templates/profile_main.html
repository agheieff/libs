<main style="max-width:960px;margin:24px auto;padding:0 16px;">
  <h1 class="t-fg">Profile</h1>
  {% if agent %}
    <p class="t-muted">Authenticated agent id: <strong class="t-fg">{{ agent.id }}</strong></p>
  {% else %}
    <p class="t-muted">You are not authenticated.</p>
  {% endif %}

  <div class="t-panel" style="margin-top:16px;padding:16px;border:1px solid var(--border);border-radius:6px;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
      <h2 style="margin:0;font-size:18px;">{{ 'Profiles' if multi_profile else 'Profile Info' }}</h2>
      {% if multi_profile %}
        <button id="btn-new" class="t-btn" style="padding:6px 10px;">New profile</button>
      {% endif %}
    </div>
    <div id="profiles-status" class="t-muted" style="margin-top:8px;">Loading…</div>
    <table id="profiles-table" style="width:100%;border-collapse:collapse;margin-top:8px;">
      <tbody id="profiles-body"></tbody>
    </table>
  </div>

  <script src="/ui-static/modal.js"></script>
  <script src="/ui-static/toast.js"></script>
  <script>
  (function(){
    const MULTI = {{ 'true' if multi_profile else 'false' }};
    const statusEl = document.getElementById('profiles-status');
    const tbody = document.getElementById('profiles-body');
    const newBtn = document.getElementById('btn-new');

    // extensibility hook
    window.ProfileTable = window.ProfileTable || { columns: [], addColumn(col){ try{ this.columns.push(col); }catch(e){} } };

    function toast(kind, msg){
      try { if (window.ArcadiaToast) { (window.ArcadiaToast[kind]||window.ArcadiaToast.info)(String(msg||'')); return; } } catch {}
      console[(kind==='error'?'error':'log')](msg);
    }

    function rowDividerStyle(i){ return i===0 ? '' : 'border-top:1px solid var(--border);'; }

    function updateDeleteButtons(){
      try{
        const rows = tbody ? tbody.querySelectorAll('tr') : [];
        const shouldDisable = (!MULTI) || (rows.length <= 1);
        (tbody ? tbody.querySelectorAll('.del-btn') : []).forEach(function(btn){
          try{
            btn.disabled = !!shouldDisable;
            btn.title = shouldDisable ? 'Cannot delete last profile' : 'Delete';
          }catch{}
        });
      }catch{}
    }

    function renderRows(list){
      tbody.innerHTML = '';
      if (!Array.isArray(list) || !list.length){
        statusEl.textContent = 'No profiles yet.';
        return;
      }
      statusEl.textContent = '';
      list.forEach((p, i)=> tbody.appendChild(renderRow(p, 'view', i)));
      updateDeleteButtons();
    }

    function renderRow(p, state, index){
      const tr = document.createElement('tr');
      tr.dataset.id = String(p.id||'');

      const tdName = document.createElement('td');
      tdName.style.cssText = 'padding:8px 0;'+rowDividerStyle(index);
      const nameWrap = document.createElement('div');
      // Grid: 32ch for name, 1fr spacer, min-content for buttons
      nameWrap.style.cssText = 'display:grid;align-items:center;gap:8px;grid-template-columns:32ch 1fr min-content;';
      const nameView = document.createElement('div');
      nameView.className = 'name-view';
      nameView.textContent = p.display_name || ('#'+p.id);
      nameView.style.gridColumn = '1';
      const nameEdit = document.createElement('div');
      nameEdit.className = 'name-edit';
      nameEdit.style.display = 'none';
      const input = document.createElement('input');
      input.type = 'text';
      input.value = p.display_name || '';
      // Enforce 32-char limit and fit within 32ch column
      try { input.maxLength = 32; } catch {}
      try { input.setAttribute('maxlength','32'); } catch {}
      input.style.cssText = 'width:100%; padding:6px; border:1px solid var(--border); border-radius:4px; background:var(--panel); color:var(--fg);';
      nameEdit.appendChild(input);
      nameEdit.style.gridColumn = '1';
      const btnEdit = document.createElement('button');
      btnEdit.className = 't-btn edit-btn';
      btnEdit.title = 'Edit';
      btnEdit.textContent = '✎';
      btnEdit.style.gridColumn = '3';
      const btnSave = document.createElement('button');
      btnSave.className = 't-btn save-btn';
      btnSave.title = 'Save';
      btnSave.textContent = '✓';
      btnSave.style.display = 'none';
      btnSave.style.gridColumn = '3';
      nameWrap.appendChild(nameView);
      nameWrap.appendChild(nameEdit);
      nameWrap.appendChild(btnEdit);
      nameWrap.appendChild(btnSave);
      tdName.appendChild(nameWrap);

      // extra columns container for future/app columns
      const tdExtra = document.createElement('td');
      // Make this middle column consume available table width
      tdExtra.style.cssText = 'padding:8px 0; width:99%;'+rowDividerStyle(index);
      tdExtra.className = 'extra-cols';

      const tdDel = document.createElement('td');
      tdDel.style.cssText = 'padding:8px 0; text-align:right;'+rowDividerStyle(index);
      const btnDel = document.createElement('button');
      btnDel.className = 't-btn del-btn';
      btnDel.title = 'Delete';
      btnDel.textContent = '🗑️';
      tdDel.appendChild(btnDel);

      tr.appendChild(tdName);
      tr.appendChild(tdExtra);
      tr.appendChild(tdDel);

      function setState(s){
        state = s;
        const editing = (s==='edit');
        nameView.style.display = editing ? 'none' : '';
        nameEdit.style.display = editing ? '' : 'none';
        btnEdit.style.display = editing ? 'none' : '';
        btnSave.style.display = editing ? '' : 'none';
        // re-render extra columns
        tdExtra.innerHTML='';
        try{ (window.ProfileTable.columns||[]).forEach(function(col){
          try { col.render && col.render(p, tdExtra, s); } catch {}
        }); }catch{}
      }

      async function save(){
        const newName = (input.value||'').trim();
        if (!tr.dataset.id || tr.dataset.id === 'new'){
          // create
          try{
            const res = await fetch('/auth/profiles/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ display_name: newName||null, prefs: null, extras: null }) });
            if(!res.ok){ const t = await res.text(); const d = (JSON.parse(t)||{}); const m = (d && d.detail) || 'Create failed'; toast('error', m); return; }
            const created = await res.json();
            p = created;
            tr.dataset.id = String(created.id);
            nameView.textContent = created.display_name || ('#'+created.id);
            setState('view');
            updateDeleteButtons();
            window.dispatchEvent(new CustomEvent('profile:created',{detail:{profile:created}}));
          }catch(e){ toast('error','Network error'); }
        } else {
          // update
          try{
            const res = await fetch('/auth/profiles/'+encodeURIComponent(tr.dataset.id), { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ display_name: newName||null }) });
            if(!res.ok){ const t = await res.text(); const d = (JSON.parse(t)||{}); const m = (d && d.detail) || 'Update failed'; toast('error', m); return; }
            const updated = await res.json();
            p = updated;
            nameView.textContent = updated.display_name || ('#'+updated.id);
            setState('view');
            window.dispatchEvent(new CustomEvent('profile:updated',{detail:{profile:updated}}));
          }catch(e){ toast('error','Network error'); }
        }
      }

      btnEdit.addEventListener('click', function(){ setState('edit'); setTimeout(()=>{ try{ input.focus(); input.select(); }catch{} }, 0); });
      btnSave.addEventListener('click', save);
      input.addEventListener('keydown', function(e){
        if(e.key==='Enter'){ e.preventDefault(); save(); }
        if(e.key==='Escape'){
          e.preventDefault();
          if (tr.dataset.id==='new'){
            tr.remove();
            checkEmpty();
            updateDeleteButtons();
          } else {
            setState('view');
          }
        }
      });

      btnDel.addEventListener('click', async function(){
        let ok = false;
        try{ if (window.ArcadiaModal && ArcadiaModal.confirm){ ok = await ArcadiaModal.confirm('Delete profile?'); } else { ok = window.confirm('Delete profile?'); } }catch{}
        if (!ok) return;
        try{
          const res = await fetch('/auth/profiles/'+encodeURIComponent(tr.dataset.id), { method:'DELETE' });
          if(!res.ok){
            try{
              const t = await res.text();
              let d = {};
              try{ d = JSON.parse(t||''); }catch{}
              const m = (d && d.detail) || 'Delete failed';
              toast('error', m);
            }catch{ toast('error','Delete failed'); }
            return;
          }
          tr.remove();
          checkEmpty();
          updateDeleteButtons();
          window.dispatchEvent(new CustomEvent('profile:deleted',{detail:{profile:p}}));
        }catch(e){ toast('error','Network error'); }
      });

      setState(state);
      return tr;
    }

    function checkEmpty(){ if (!tbody.children.length){ statusEl.textContent='No profiles yet.'; } }

    async function load(){
      try{
        const res = await fetch('/auth/profiles/');
        if(!res.ok){ statusEl.textContent = 'Not authenticated.'; tbody.innerHTML=''; return; }
        const data = await res.json();
        if (MULTI){ renderRows(data); } else { statusEl.textContent=''; tbody.innerHTML=''; if (data[0]) tbody.appendChild(renderRow(data[0],'view',0)); updateDeleteButtons(); }
      }catch(e){ statusEl.textContent = 'Error loading.'; tbody.innerHTML=''; }
    }

    if (newBtn){
      newBtn.addEventListener('click', function(){
        statusEl.textContent='';
        const p = { id: 'new', display_name: '' };
        const tr = renderRow(p, 'edit', tbody.children.length);
        tr.dataset.id = 'new';
        tbody.prepend(tr);
        updateDeleteButtons();
        const input = tr.querySelector('.name-edit input');
        setTimeout(()=>{ try{ input && input.focus(); }catch{} }, 0);
      });
    }

    load();
  })();
  </script>
</main>
